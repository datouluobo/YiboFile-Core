<UserControl x:Class="YiboFile.RightPanelControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:YiboFile.Controls"
             xmlns:viewModels="clr-namespace:YiboFile.ViewModels"
             xmlns:local="clr-namespace:YiboFile"
             xmlns:converters="clr-namespace:YiboFile.Converters"
             HorizontalAlignment="Stretch"
             VerticalAlignment="Stretch"
             MinWidth="100">
    <Grid HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Margin="0">
        <Grid.RowDefinitions>
            <!-- è¡Œ0ï¼šæ ‡é¢˜æ åŒºåŸŸï¼ˆä¸Žåˆ—2å·¥å…·æ å¯¹é½ï¼‰ -->
            <RowDefinition Height="Auto"/>
            <!-- è¡Œ1ï¼šé¢„è§ˆåŒº -->
            <RowDefinition Height="*"/>
            <!-- è¡Œ2ï¼šåˆ†å‰²å™¨ -->
            <RowDefinition Height="Auto"/>
            <!-- è¡Œ3ï¼šå¤‡æ³¨åŒº -->
            <RowDefinition Height="{Binding NotesHeight, Mode=TwoWay, FallbackValue=200}" MinHeight="100"/>
        </Grid.RowDefinitions>
        
        <!-- è¡Œ0ï¼šæ ‡é¢˜æ ï¼ˆå ä½ï¼Œä¸Žåˆ—2å·¥å…·æ å¯¹é½ï¼‰ -->
        <Border Grid.Row="0" Height="50" Background="Transparent" IsHitTestVisible="False"/>
        
        <!-- Row 1: Preview Area -->
        <Border Grid.Row="1" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1">
            <Grid Name="PreviewGrid" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" ClipToBounds="True">
                <Grid.Resources>
                    <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
                    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
                    
                    <Style x:Key="ToolbarToggleButtonStyle" TargetType="ToggleButton">
                        <Setter Property="Padding" Value="8,4"/>
                        <Setter Property="Margin" Value="2"/>
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderBrush" Value="{DynamicResource ButtonBorderBrush}"/>
                        <Setter Property="Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                        <Setter Property="BorderThickness" Value="1"/>
                        <Setter Property="FontSize" Value="12"/>
                        <Setter Property="HorizontalContentAlignment" Value="Center"/>
                        <Setter Property="VerticalContentAlignment" Value="Center"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ToggleButton">
                                    <Border x:Name="border"
                                            Background="{TemplateBinding Background}" 
                                            BorderBrush="{TemplateBinding BorderBrush}" 
                                            BorderThickness="{TemplateBinding BorderThickness}"
                                            CornerRadius="4">
                                        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}" 
                                                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                          Margin="{TemplateBinding Padding}"/>
                                    </Border>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
                                            <Setter Property="BorderBrush" Value="{DynamicResource AccentHoverBrush}"/>
                                        </Trigger>
                                        <Trigger Property="IsChecked" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource AccentLightBrush}"/>
                                            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                                            <Setter Property="Foreground" Value="{DynamicResource AccentBrush}"/>
                                        </Trigger>
                                        <Trigger Property="IsEnabled" Value="False">
                                            <Setter Property="Opacity" Value="0.6"/>
                                        </Trigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                    
                    <!-- Previews DataTemplates -->
                    <DataTemplate DataType="{x:Type viewModels:Previews.ImagePreviewViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Top Toolbar -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <Grid>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Dimensions}" Foreground="Gray" VerticalAlignment="Center" Margin="5,0" FontSize="12"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                        <Button Content="âž•" Command="{Binding ZoomInCommand}" CommandParameter="{Binding ElementName=PreviewImage}" Width="34" Height="34" Margin="2" ToolTip="æ”¾å¤§"
                                                Style="{DynamicResource IconButton}" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                        <Button Content="âž–" Command="{Binding ZoomOutCommand}" CommandParameter="{Binding ElementName=PreviewImage}" Width="34" Height="34" Margin="2" ToolTip="ç¼©å°"
                                                Style="{DynamicResource IconButton}" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                        <Button Content="1:1" Command="{Binding ResetZoomCommand}" MinWidth="34" Height="34" Padding="5,0" Margin="2" ToolTip="åŽŸå§‹å¤§å°"
                                                Style="{DynamicResource IconButton}" FontSize="12" FontWeight="Bold" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                        <Button Content="â›¶" Command="{Binding FitToWindowCommand}" Width="34" Height="34" Margin="2" ToolTip="é€‚åº”çª—å£"
                                                Style="{DynamicResource IconButton}" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                        <Button Content="â†»" Command="{Binding RotateCommand}" Width="34" Height="34" Margin="2" ToolTip="æ—‹è½¬"
                                                Style="{DynamicResource IconButton}" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                        <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Margin="5,0,0,0" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                    </StackPanel>
                                </Grid>
                            </Border>

                            <ScrollViewer Grid.Row="1" PanningMode="Both">
                                <ScrollViewer.Style>
                                    <Style TargetType="ScrollViewer">
                                        <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
                                        <Setter Property="VerticalScrollBarVisibility" Value="Auto"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsFitToWindow}" Value="True">
                                                <Setter Property="HorizontalScrollBarVisibility" Value="Disabled"/>
                                                <Setter Property="VerticalScrollBarVisibility" Value="Disabled"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ScrollViewer.Style>
                                <Image x:Name="PreviewImage" Source="{Binding ImageSource}" RenderOptions.BitmapScalingMode="Fant">
                                    <Image.LayoutTransform>
                                        <TransformGroup>
                                            <ScaleTransform ScaleX="{Binding ZoomLevel}" ScaleY="{Binding ZoomLevel}"/>
                                            <RotateTransform Angle="{Binding RotationAngle}"/>
                                        </TransformGroup>
                                    </Image.LayoutTransform>
                                    <Image.Style>
                                        <Style TargetType="Image">
                                            <Setter Property="Stretch" Value="None"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsFitToWindow}" Value="True">
                                                    <Setter Property="Stretch" Value="Uniform"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Image.Style>
                                </Image>
                            </ScrollViewer>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.MarkdownPreviewViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Toolbar -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <ToggleButton Content="ðŸ“„ é¢„è§ˆ/æºç " IsChecked="{Binding IsSourceView}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <ToggleButton Content="è‡ªåŠ¨æ¢è¡Œ" IsChecked="{Binding IsWordWrap}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" Visibility="{Binding IsSourceView, Converter={StaticResource BooleanToVisibilityConverter}}" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="åˆ·æ–°" Command="{Binding ReloadCommand}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <controls:MarkdownPreviewControl Grid.Row="1"/>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.TextPreviewViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Toolbar using standard controls to match TextPreviewToolbar features -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <TextBlock Text="{Binding Encoding.EncodingName}" VerticalAlignment="Center" Margin="0,0,10,0" Foreground="Gray" FontSize="12"/>
                                    <ToggleButton Content="è‡ªåŠ¨æ¢è¡Œ" IsChecked="{Binding IsWordWrap}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <ToggleButton Content="ç¼–è¾‘" IsChecked="{Binding IsEditMode}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="ä¿å­˜" Command="{Binding SaveCommand}" Visibility="{Binding IsEditMode, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <TextBox Grid.Row="1" Text="{Binding Content, UpdateSourceTrigger=PropertyChanged}" 
                                     AcceptsReturn="True" 
                                     IsReadOnly="{Binding IsEditMode, Converter={StaticResource InverseBooleanConverter}}" 
                                     TextWrapping="{Binding IsWordWrap, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter='Wrap'}"
                                     FontFamily="Consolas" 
                                     VerticalScrollBarVisibility="Auto"
                                     HorizontalScrollBarVisibility="Auto"
                                     BorderThickness="0"
                                     Padding="5"/>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.ArchivePreviewViewModel}">
                        <ListView ItemsSource="{Binding Entries}">
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="åç§°" DisplayMemberBinding="{Binding Name}" Width="200"/>
                                    <GridViewColumn Header="å¤§å°" DisplayMemberBinding="{Binding Size}" Width="80"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.ChmPreviewViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <ToggleButton Content="ç›®å½•" IsChecked="{Binding IsTocVisible}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <controls:ChmPreviewControl Grid.Row="1"/>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.WordPreviewViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Toolbar -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="ðŸ”„ è½¬æ¢" Command="{Binding ConvertCommand}" Visibility="{Binding NeedsConversion, Converter={StaticResource BooleanToVisibilityConverter}}" IsEnabled="{Binding IsConverting, Converter={StaticResource InverseBooleanConverter}}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="åˆ·æ–°" Command="{Binding ReloadCommand}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <Grid Grid.Row="1">
                                <controls:WordPreviewControl/>
                                
                                <!-- Conversion Overlay -->
                                <Border Background="#CCFFFFFF" Visibility="{Binding NeedsConversion, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                        <TextBlock Text="âš ï¸" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,10"/>
                                        <TextBlock Text="{Binding ConversionMessage}" FontSize="16" Foreground="Gray" TextWrapping="Wrap" TextAlignment="Center" MaxWidth="400" Margin="0,0,0,20"/>
                                        <Button Content="è½¬æ¢ä¸º DOCX é¢„è§ˆ" Command="{Binding ConvertCommand}" IsEnabled="{Binding IsConverting, Converter={StaticResource InverseBooleanConverter}}" Padding="20,10" FontSize="16" HorizontalAlignment="Center"/>
                                        <ProgressBar IsIndeterminate="True" Height="4" Margin="0,20,0,0" Visibility="{Binding IsConverting, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.MediaPreviewViewModel}">
                        <Grid>
                            <controls:VideoPreviewControl FilePath="{Binding FilePath}">
                                <controls:VideoPreviewControl.Style>
                                    <Style TargetType="{x:Type controls:VideoPreviewControl}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsVideo}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:VideoPreviewControl.Style>
                            </controls:VideoPreviewControl>
                            
                            <controls:AudioPreviewControl FilePath="{Binding FilePath}">
                                <controls:AudioPreviewControl.Style>
                                    <Style TargetType="{x:Type controls:AudioPreviewControl}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsVideo}" Value="False">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </controls:AudioPreviewControl.Style>
                            </controls:AudioPreviewControl>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.FolderPreviewViewModel}">
                        <ListView ItemsSource="{Binding Items}">
                            <ListView.View>
                                <GridView>
                                    <GridViewColumn Header="åç§°" DisplayMemberBinding="{Binding Name}" Width="150"/>
                                    <GridViewColumn Header="å¤§å°" DisplayMemberBinding="{Binding Size}" Width="70"/>
                                    <GridViewColumn Header="ä¿®æ”¹æ—¥æœŸ" DisplayMemberBinding="{Binding ModifiedDate}" Width="120"/>
                                </GridView>
                            </ListView.View>
                        </ListView>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.DocumentPreviewViewModel}">
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="ðŸ“„" FontSize="64" HorizontalAlignment="Center" Margin="0,0,0,20"/>
                            <TextBlock Text="{Binding FileInfo}" TextAlignment="Center" Foreground="{DynamicResource TextSecondaryBrush}"/>
                            <Button Content="ä½¿ç”¨é»˜è®¤ç¨‹åºæ‰“å¼€" Margin="0,20,0,0" Padding="15,5"
                                    Command="{Binding OpenExternalCommand}"
                                    Style="{DynamicResource PrimaryButtonStyle}"/>
                        </StackPanel>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.PdfPreviewViewModel}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- Simple Toolbar for PDF -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <controls:PdfView Grid.Row="1" FilePath="{Binding FilePath}"/>
                        </Grid>
                    </DataTemplate>
                    
                    <DataTemplate DataType="{x:Type viewModels:Previews.HtmlPreviewViewModel}">
                        <Grid>
                             <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <!-- Toolbar -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                    <ToggleButton Content="ðŸ“„ æºç " IsChecked="{Binding IsSourceView}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <ToggleButton Content="ç¼–è¾‘" IsChecked="{Binding IsEditMode}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <ToggleButton Content="è‡ªåŠ¨æ¢è¡Œ" IsChecked="{Binding IsWordWrap}" Style="{StaticResource ToolbarToggleButtonStyle}" Margin="0,0,5,0" Height="34" Padding="10,0" Visibility="{Binding IsSourceView, Converter={StaticResource BooleanToVisibilityConverter}}" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="ä¿å­˜" Command="{Binding SaveCommand}" Visibility="{Binding IsEditMode, Converter={StaticResource BooleanToVisibilityConverter}}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="åˆ·æ–°" Command="{Binding ReloadCommand}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                    <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <controls:HtmlPreviewControl Grid.Row="1" FilePath="{Binding FilePath}"/>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.ExcelPreviewViewModel}">
                        <Grid>
                             <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                             <!-- Toolbar -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                     <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <controls:ExcelPreviewControl Grid.Row="1"/>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.CadPreviewViewModel}">
                        <Grid>
                             <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                             <!-- Toolbar -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                     <Button Content="{Binding ConvertStatusText}" Command="{Binding ConvertCommand}" Visibility="{Binding IsDwg, Converter={StaticResource BooleanToVisibilityConverter}}" IsEnabled="{Binding IsConverting, Converter={StaticResource InverseBooleanConverter}}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                     <Button Content="åˆ·æ–°" Command="{Binding RefreshCommand}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                     <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <controls:CadPreviewControl Grid.Row="1"/>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.PowerPointPreviewViewModel}">
                        <Grid>
                             <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                             <!-- Toolbar -->
                            <Border Grid.Row="0" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,1" Padding="5">
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                     <Button Content="åˆ·æ–°" Command="{Binding ReloadCommand}" Margin="0,0,5,0" Height="34" Padding="10,0" FontSize="12" VerticalContentAlignment="Center"/>
                                     <Button Content="æ‰“å¼€" Command="{Binding OpenExternalCommand}" Height="34" MinWidth="60" Padding="10,0" FontSize="12" VerticalContentAlignment="Center" HorizontalContentAlignment="Center"/>
                                </StackPanel>
                            </Border>
                            <controls:PowerPointPreviewControl Grid.Row="1"/>
                        </Grid>
                    </DataTemplate>

                    <DataTemplate DataType="{x:Type viewModels:Previews.ErrorPreviewViewModel}">
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="âŒ" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,10"/>
                            <TextBlock Text="{Binding ErrorMessage}" FontSize="16" Foreground="Gray" TextWrapping="Wrap" HorizontalAlignment="Center"/>
                        </StackPanel>
                    </DataTemplate>
                </Grid.Resources>

                <!-- MVVM Preview Content -->
                <ContentPresenter Content="{Binding ActivePreview}"/>

                <!-- Loading Overlay -->
                <Grid Visibility="{Binding ActivePreview.IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" Background="#88FFFFFF">
                    <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                        <ProgressBar IsIndeterminate="True" Width="200" Height="4" Margin="0,0,0,10"/>
                        <TextBlock Text="æ­£åœ¨åŠ è½½..." HorizontalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </Grid>
        </Border>

        <!-- è¡Œ2ï¼šåˆ†å‰²å™¨ -->
        <controls:CollapsibleGridSplitter Grid.Row="2" 
                      Style="{StaticResource HorizontalCollapsibleGridSplitterStyle}"
                      CollapseMode="Both"
                      HorizontalAlignment="Stretch"
                      Panel.ZIndex="999"
                      AutoFillNeighbor="True"
                      ShowsPreview="True"/>
        <Border Grid.Row="2" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,1,0,0" VerticalAlignment="Center"/>

        <!-- è¡Œ3ï¼šå¤‡æ³¨åŒº -->
        <Border Grid.Row="3" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,0,0,0">
            <TextBox Name="NotesTextBox" Padding="8,4,8,4" 
                     AcceptsReturn="True" 
                     TextWrapping="Wrap"
                     VerticalScrollBarVisibility="Auto"
                     HorizontalAlignment="Stretch"
                     VerticalAlignment="Stretch"
                     Text="{Binding CurrentNotes, UpdateSourceTrigger=PropertyChanged}"
                     Background="{DynamicResource AppBackgroundBrush}" BorderBrush="Transparent" BorderThickness="0"/>
        </Border>
    </Grid>
</UserControl>
