# OoiMRR è®¾ç½®ç³»ç»Ÿæ¶æ„åˆ†æ

## æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£åˆ†æäº†OoiMRRåº”ç”¨ç¨‹åºä¸­è®¾ç½®é¢æ¿ã€çŠ¶æ€ç®¡ç†å’Œé…ç½®ä¿å­˜çš„å®Œæ•´æ¶æ„ï¼Œè¯†åˆ«äº†å½“å‰ç³»ç»Ÿçš„é—®é¢˜ï¼Œå¹¶æä¾›äº†æœªæ¥æ”¹è¿›çš„å»ºè®®ã€‚

**å…³é”®å‘ç°ï¼š**
- é…ç½®ä¿å­˜èŒè´£åˆ†æ•£åœ¨å¤šä¸ªç»„ä»¶ä¸­
- ç¼ºä¹ç»Ÿä¸€çš„é…ç½®æ›´æ–°åè°ƒæœºåˆ¶
- å¤šæ¬¡å®Œæ•´é…ç½®ä¿å­˜å¯¼è‡´è¦†ç›–é—®é¢˜
- è®¾ç½®é¢æ¿å®æ—¶ä¿å­˜ä¸å…³é—­æ—¶ä¿å­˜å­˜åœ¨å†²çª

---

## 1. æ¶æ„æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒç»„ä»¶

```mermaid
graph TD
    A[MainWindow] --> B[SettingsPanelControl]
    A --> C[WindowStateManager]
    A --> D[ConfigService]
    
    B --> E1[GeneralSettingsPanel]
    B --> E2[FileListSettingsPanel]
    B --> E3[LibrarySettingsPanel]
    B --> E4[PathSettingsPanel]
    B --> E5[TagSettingsPanel]
    B --> E6[TagTrainSettingsPanel]
    
    E1 --> F[ConfigManager]
    E2 --> F
    E3 --> F
    E4 --> F
    E5 --> F
    E6 --> F
    
    C --> F
    D --> F
    
    G[SettingsOverlayController] --> B
    G --> D
```

### 1.2 æ•°æ®æµå‘

```mermaid
sequenceDiagram
    participant User
    participant SettingsPanel
    participant ConfigManager
    participant File
    
    User->>SettingsPanel: ä¿®æ”¹è®¾ç½®
    SettingsPanel->>ConfigManager: Load()
    ConfigManager->>File: è¯»å– ooi_config.json
    ConfigManager->>SettingsPanel: è¿”å› AppConfig
    SettingsPanel->>SettingsPanel: ä¿®æ”¹ config å±æ€§
    SettingsPanel->>ConfigManager: Save(config)
    ConfigManager->>File: å†™å…¥æ•´ä¸ªé…ç½®
```

---

## 2. ç»„ä»¶è¯¦ç»†åˆ†æ

### 2.1 ConfigManager (é™æ€ç±»)
**æ–‡ä»¶ï¼š** [`ConfigManager.cs`](file:///f:/Download/GitHub/OoiMRR/Services/Core/ConfigManager.cs)

**èŒè´£ï¼š**
- é…ç½®æ–‡ä»¶çš„è¯»å†™ï¼ˆJSONåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼‰
- é…ç½®æ–‡ä»¶è·¯å¾„ç®¡ç†
- é…ç½®å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½
- é…ç½®è¿ç§»ï¼ˆå‘åå…¼å®¹ï¼‰

**å…³é”®æ–¹æ³•ï¼š**
- `Load()` â†’ `AppConfig` - ä»ç£ç›˜åŠ è½½é…ç½®
- `Save(AppConfig)` - å°†æ•´ä¸ªAppConfigå¯¹è±¡ä¿å­˜åˆ°ç£ç›˜
- `GetConfigFilePath()` - è¿”å› `AppData/ooi_config.json`

**é—®é¢˜ï¼š**
- âš ï¸ `Save()` æ–¹æ³•ä¿å­˜**æ•´ä¸ª**`AppConfig`å¯¹è±¡ï¼Œå¯èƒ½è¦†ç›–å…¶ä»–åœ°æ–¹ä¿®æ”¹çš„å€¼
- âš ï¸ æ²¡æœ‰éƒ¨åˆ†æ›´æ–°æœºåˆ¶
- âš ï¸ å¹¶å‘ä¿å­˜æ—¶å¯èƒ½å‡ºç°ç«äº‰æ¡ä»¶

---

### 2.2 AppConfig (æ•°æ®ç±»)
**æ–‡ä»¶ï¼š** [`ConfigManager.cs`](file:///f:/Download/GitHub/OoiMRR/Services/Core/ConfigManager.cs#L10-L75)

**èŒè´£ï¼š**
- å­˜å‚¨æ‰€æœ‰åº”ç”¨é…ç½®æ•°æ®

**é…ç½®åˆ†ç±»ï¼š**

| ç±»åˆ« | ç¤ºä¾‹å±æ€§ | ç®¡ç†ç»„ä»¶ |
|------|----------|----------|
| çª—å£çŠ¶æ€ | `WindowWidth`, `WindowHeight`, `IsMaximized` | WindowStateManager |
| å¸ƒå±€ | `ColLeftWidth`, `ColCenterWidth`, `ColRightWidth` | WindowStateManager |
| åˆ—å®½ | `ColNameWidth`, `ColTagsWidth`, `ColNotesWidth` | FileListSettingsPanel, ColumnService |
| å¯¼èˆª | `LastPath`, `LastLibraryId` | NavigationStateManager |
| æ ‡ç­¾é¡µ | `OpenTabs`, `ActiveTabKey` | WindowStateManager |
| UIè®¾ç½® | `ActionButtons`, `DarkMode` | GeneralSettingsPanel |
| å…¶ä»– | `SortColumn`, `ColumnOrder` | ColumnService |

**é—®é¢˜ï¼š**
- âš ï¸ å•ä¸€é…ç½®å¯¹è±¡è¢«å¤šä¸ªç»„ä»¶åŒæ—¶ä¿®æ”¹
- âš ï¸ ç¼ºä¹é…ç½®é¡¹çš„æ‰€æœ‰æƒå®šä¹‰
- âš ï¸ æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶æˆ–å†²çªæ£€æµ‹

---

### 2.3 SettingsPanelControl
**æ–‡ä»¶ï¼š** [`SettingsPanelControl.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/SettingsPanelControl.xaml.cs)

**èŒè´£ï¼š**
- è®¾ç½®UIçš„å®¹å™¨å’Œè·¯ç”±å™¨
- ç®¡ç†è®¾ç½®åˆ†ç±»åˆ‡æ¢
- åè°ƒè®¾ç½®é¢æ¿çš„ç”Ÿå‘½å‘¨æœŸ

**å…³é”®æ–¹æ³•ï¼š**
- `LoadCategory(string)` - åˆ›å»ºå¹¶åŠ è½½å¯¹åº”çš„è®¾ç½®é¢æ¿
- `SaveAllSettings()` - è°ƒç”¨å½“å‰é¢æ¿çš„ `SaveSettings()`
- `LoadAllSettings()` - è°ƒç”¨å½“å‰é¢æ¿çš„ `LoadSettings()`

**é—®é¢˜ï¼š**
- âš ï¸ æ¯æ¬¡åˆ‡æ¢åˆ†ç±»éƒ½åˆ›å»ºæ–°çš„é¢æ¿å®ä¾‹ï¼ˆæ— çŠ¶æ€ç¼“å­˜ï¼‰
- âš ï¸ `LoadCategory` ä¼šè°ƒç”¨ `LoadSettings()`ï¼Œå¯èƒ½è§¦å‘ä¸å¿…è¦çš„ç£ç›˜è¯»å–
- âš ï¸ äº‹ä»¶è®¢é˜…ç®¡ç†è¾ƒå¤æ‚

---

### 2.4 ISettingsPanel æ¥å£

**å®šä¹‰ï¼š**
```csharp
public interface ISettingsPanel
{
    void SaveSettings();
    void LoadSettings();
    event EventHandler SettingsChanged;
}
```

**å®ç°ç±»ï¼š**
- `GeneralSettingsPanel` - é€šç”¨è®¾ç½®ï¼ˆUIã€æŒ‰é’®ï¼‰
- `FileListSettingsPanel` - æ–‡ä»¶åˆ—è¡¨åˆ—å®½è®¾ç½®
- `LibrarySettingsPanel` - åº“è®¾ç½®
- `PathSettingsPanel` - è·¯å¾„è®¾ç½®
- `TagSettingsPanel` - æ ‡ç­¾è®¾ç½®
- `TagTrainSettingsPanel` - TagTrainè®¾ç½®

**å½“å‰å®ç°æ¨¡å¼ï¼š**
å„ä¸ªè®¾ç½®é¢æ¿çš„ `SaveSettings()` å’Œå®æ—¶ä¿å­˜æ–¹æ³•éƒ½è°ƒç”¨ï¼š
```csharp
var config = ConfigManager.Load();
config.SomeProperty = newValue;
ConfigManager.Save(config);
```

**é—®é¢˜ï¼š**
- âŒ **è‡´å‘½ç¼ºé™·**ï¼šæ¯ä¸ªé¢æ¿ä¿å­˜æ—¶éƒ½è¦†ç›–æ•´ä¸ªé…ç½®æ–‡ä»¶
- âŒ Load-Modify-Save æ¨¡å¼åœ¨å¹¶å‘åœºæ™¯ä¸‹ä¸å®‰å…¨
- âŒ æ²¡æœ‰åè°ƒæœºåˆ¶é˜²æ­¢äº’ç›¸è¦†ç›–

---

### 2.5 SettingsOverlayController
**æ–‡ä»¶ï¼š** [`SettingsOverlayController.cs`](file:///f:/Download/GitHub/OoiMRR/Services/UI/Settings/SettingsOverlayController.cs)

**èŒè´£ï¼š**
- æ§åˆ¶è®¾ç½®é¢æ¿çš„æ˜¾ç¤º/éšè—
- åè°ƒè®¾ç½®åº”ç”¨æµç¨‹

**å…³é”®æ–¹æ³•ï¼š**
- `Show()` - æ˜¾ç¤ºè®¾ç½®ï¼Œè°ƒç”¨ `LoadAllSettings()`
- `Hide` - éšè—è®¾ç½®ï¼Œ~~è°ƒç”¨ `SaveAllSettings()`~~ï¼ˆå·²ç§»é™¤ï¼‰

**æœ€è¿‘ä¿®æ”¹ï¼š**
- âœ… æ³¨é‡Šæ‰ `Hide()` ä¸­çš„ `SaveAllSettings()` è°ƒç”¨ï¼Œé¿å…è¦†ç›–é—®é¢˜

---

### 2.6 WindowStateManager
**æ–‡ä»¶ï¼š** [`WindowStateManager.cs`](file:///f:/Download/GitHub/OoiMRR/Services/UI/WindowStateManager.cs)

**èŒè´£ï¼š**
- ä¿å­˜/æ¢å¤çª—å£å¤§å°ã€ä½ç½®ã€æœ€å¤§åŒ–çŠ¶æ€
- ä¿å­˜/æ¢å¤åˆ†å‰²çº¿ä½ç½®ï¼ˆä¸‰åˆ—å¸ƒå±€ï¼‰
- ä¿å­˜/æ¢å¤å¯¼èˆªçŠ¶æ€
- ä¿å­˜/æ¢å¤æ ‡ç­¾é¡µçŠ¶æ€

**å…³é”®æ–¹æ³•ï¼š**
- `SaveAllState()` - ä¿å­˜æ‰€æœ‰UIçŠ¶æ€
- `SaveWindowState()` - ä¿å­˜çª—å£çŠ¶æ€
- `SaveSplitterPositions()` - ä¿å­˜åˆ†å‰²çº¿ä½ç½®
- `SaveNavigationState()` - ä¿å­˜å¯¼èˆªçŠ¶æ€
- `SaveTabsState()` - ä¿å­˜æ ‡ç­¾é¡µçŠ¶æ€

**è°ƒç”¨æ—¶æœºï¼š**
- çª—å£è°ƒæ•´å¤§å°å
- æ‹–åŠ¨åˆ†å‰²çº¿å
- åˆ‡æ¢å¯¼èˆªä½ç½®å
- æ‰“å¼€/å…³é—­æ ‡ç­¾é¡µå
- ç¨‹åºå…³é—­æ—¶ï¼ˆ`WindowLifecycleHandler.HandleClosing()`ï¼‰

**é—®é¢˜ï¼š**
- âš ï¸ ä¸è®¾ç½®é¢æ¿å…±äº« `AppConfig` å¯¹è±¡
- âš ï¸ é¢‘ç¹è°ƒç”¨ `ConfigManager.Save()` å¯èƒ½å½±å“æ€§èƒ½

---

### 2.7 ConfigService
**æ–‡ä»¶ï¼š** [`ConfigService.cs`](file:///f:/Download/GitHub/OoiMRR/Services/Core/Config/ConfigService.cs)

**èŒè´£ï¼š**
- åº”ç”¨é…ç½®åˆ°UIï¼ˆå¯åŠ¨æ—¶ï¼‰
- æä¾›å»¶è¿Ÿä¿å­˜æœºåˆ¶ï¼ˆé˜²æŠ–åŠ¨ï¼‰
- ä¿å­˜å½“å‰é…ç½®

**å…³é”®æ–¹æ³•ï¼š**
- `ApplyConfig()` - å°†é…ç½®åº”ç”¨åˆ°çª—å£
- `SaveCurrentConfig()` - ä¿å­˜å½“å‰çŠ¶æ€åˆ°é…ç½®
- `StartDelayedSave()` - 300msé˜²æŠ–ä¿å­˜

**é—®é¢˜ï¼š**
- âš ï¸ `SaveCurrentConfig()` ä¹Ÿè°ƒç”¨ `ConfigManager.Save()`
- âš ï¸ æ³¨é‡Šè¯´æ˜"åˆ—å®½ç”± WindowStateManager ç®¡ç†ï¼Œè¿™é‡Œä¸ä¿å­˜"ï¼Œä½†å®é™…ä»å¯èƒ½å†²çª

---

### 2.8 ColumnService
**æ–‡ä»¶ï¼š** [`ColumnService.cs`](file:///f:/Download/GitHub/OoiMRR/Services/UI/ColumnManagement/ColumnService.cs)

**èŒè´£ï¼š**
- ç®¡ç†æ–‡ä»¶åˆ—è¡¨çš„åˆ—å®½åº¦
- ç®¡ç†åˆ—é¡ºåºå’Œå¯è§æ€§
- ä¿å­˜åˆ—é…ç½®

**å…³é”®æ–¹æ³•ï¼š**
- `SaveColumnWidths(FileBrowserControl)` - ä¿å­˜åˆ—å®½åº¦åˆ°é…ç½®
- `RememberColumnWidth(string, GridViewColumn)` - è®°ä½å•åˆ—å®½åº¦

**æœ€è¿‘ä¿®æ”¹ï¼š**
- âœ… Tags å’Œ Notes åˆ—çš„å®½åº¦ä¸å†ä¿å­˜ï¼ˆæ³¨é‡Šæ‰ï¼‰

---

## 3. ç°æœ‰é—®é¢˜æ€»ç»“

### 3.1 é…ç½®å†²çªé—®é¢˜

**é—®é¢˜æè¿°ï¼š**
å¤šä¸ªç»„ä»¶åŒæ—¶ä¿®æ”¹å¹¶ä¿å­˜æ•´ä¸ª`AppConfig`å¯¹è±¡ï¼Œå¯¼è‡´åä¿å­˜çš„è¦†ç›–å…ˆä¿å­˜çš„ã€‚

**ç¤ºä¾‹åœºæ™¯ï¼š**
```
1. ç”¨æˆ·åœ¨ FileListSettingsPanel ä¿®æ”¹ ColNotesWidth=300
   â†’ ConfigManager.Save(config) â†’ å†™å…¥ç£ç›˜ âœ…
   
2. ç”¨æˆ·åˆ‡æ¢åˆ° GeneralSettingsPanel

3. ç”¨æˆ·å…³é—­è®¾ç½®
   â†’ SettingsOverlayController.Hide()
   â†’ SaveAllSettings()
   â†’ GeneralSettingsPanel.SaveSettings()
   â†’ ConfigManager.Load() â†’ config.ColNotesWidth=115 (æ—§å€¼)
   â†’ ConfigManager.Save(config) â†’ è¦†ç›–ï¼âŒ
```

**æ ¹æœ¬åŸå› ï¼š**
- Load-Modify-Save æ¨¡å¼ä¸æ”¯æŒå¹¶å‘ä¿®æ”¹
- æ²¡æœ‰é…ç½®æ›´æ–°åè°ƒæœºåˆ¶
- `ConfigManager.Save()` ä¿å­˜æ•´ä¸ªå¯¹è±¡è€Œééƒ¨åˆ†æ›´æ–°

### 3.2 èŒè´£ä¸æ¸…

| é…ç½®é¡¹ | åº”ç®¡ç†è€… | å®é™…ç®¡ç†è€… |
|--------|----------|------------|
| `ColNotesWidth` | FileListSettingsPanel | FileListSettingsPanel, ColumnService |
| `WindowWidth` | WindowStateManager | WindowStateManager, ConfigService |
| `OpenTabs` | WindowStateManager | WindowStateManager |

### 3.3 æ€§èƒ½é—®é¢˜

**é¢‘ç¹ä¿å­˜ï¼š**
- æ¯æ¬¡æ‹–åŠ¨åˆ†å‰²çº¿éƒ½ä¿å­˜é…ç½®
- æ¯æ¬¡ä¿®æ”¹è®¾ç½®éƒ½ç«‹å³ä¿å­˜
- æ²¡æœ‰ç»Ÿä¸€çš„é˜²æŠ–æœºåˆ¶

**ä¸å¿…è¦çš„ç£ç›˜I/Oï¼š**
- åˆ‡æ¢è®¾ç½®é¢æ¿æ—¶é‡æ–°åŠ è½½é…ç½®
- å¤šä¸ªç»„ä»¶åå¤ `Load()` åŒä¸€é…ç½®

### 3.4 æ‰©å±•æ€§å·®

**æ·»åŠ æ–°è®¾ç½®é¢æ¿çš„é—®é¢˜ï¼š**
- å¿…é¡»ç†è§£æ‰€æœ‰ç°æœ‰ç»„ä»¶çš„ä¿å­˜é€»è¾‘
- éœ€è¦é¿å¼€å·²è¢«å ç”¨çš„é…ç½®é¡¹
- ç¼ºä¹æ–‡æ¡£è¯´æ˜é…ç½®é¡¹æ‰€æœ‰æƒ

---

## 4. æ¨èæ¶æ„æ”¹è¿›

### 4.1 é…ç½®ç®¡ç†é‡æ„æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šå•ä¸€é…ç½®ç®¡ç†å™¨ï¼ˆæ¨èï¼‰

**æ ¸å¿ƒæ€æƒ³ï¼š**
- åˆ›å»º`ConfigurationManager`å•ä¾‹ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®è¯»å†™
- ä¸å†ç›´æ¥è°ƒç”¨`ConfigManager.Save()`ï¼Œè€Œæ˜¯é€šè¿‡`ConfigurationManager.UpdateConfig(action)`
- å†…ç½®é˜²æŠ–å’Œå†²çªæ£€æµ‹

**å®ç°ç¤ºä¾‹ï¼š**
```csharp
public class ConfigurationManager
{
    private static ConfigurationManager _instance;
    private AppConfig _config;
    private readonly object _lock = new object();
    private DispatcherTimer _saveTimer;
    
    public static ConfigurationManager Instance => _instance ??= new ConfigurationManager();
    
    private ConfigurationManager()
    {
        _config = ConfigManager.Load();
        InitializeSaveTimer();
    }
    
    /// <summary>
    /// æ›´æ–°é…ç½®ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    /// </summary>
    public void UpdateConfig(Action<AppConfig> updateAction)
    {
        lock (_lock)
        {
            updateAction(_config);
            ScheduleSave();
        }
    }
    
    /// <summary>
    /// è·å–é…ç½®å‰¯æœ¬ï¼ˆåªè¯»ï¼‰
    /// </summary>
    public AppConfig GetConfig()
    {
        lock (_lock)
        {
            // è¿”å›æ·±æ‹·è´ï¼Œé˜²æ­¢å¤–éƒ¨ä¿®æ”¹
            return CloneConfig(_config);
        }
    }
    
    private void ScheduleSave()
    {
        _saveTimer.Stop();
        _saveTimer.Start();
    }
    
    private void SaveTimer_Tick(object sender, EventArgs e)
    {
        _saveTimer.Stop();
        lock (_lock)
        {
            ConfigManager.Save(_config);
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```csharp
// FileListSettingsPanel
ConfigurationManager.Instance.UpdateConfig(config =>
{
    config.ColNotesWidth = 300;
});

// WindowStateManager
ConfigurationManager.Instance.UpdateConfig(config =>
{
    config.WindowWidth = window.Width;
    config.WindowHeight = window.Height;
});
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç»Ÿä¸€çš„é…ç½®æ›´æ–°å…¥å£
- âœ… å†…ç½®é˜²æŠ–æœºåˆ¶ï¼ˆ300msï¼‰
- âœ… çº¿ç¨‹å®‰å…¨
- âœ… é¿å…Load-Modify-Saveå†²çª

**ç¼ºç‚¹ï¼š**
- â— éœ€è¦é‡æ„æ‰€æœ‰ç°æœ‰è°ƒç”¨ç‚¹

---

#### æ–¹æ¡ˆBï¼šé…ç½®åˆ†åŒºï¼ˆä¸­ç­‰æ”¹åŠ¨ï¼‰

**æ ¸å¿ƒæ€æƒ³ï¼š**
- å°†`AppConfig`æ‹†åˆ†ä¸ºå¤šä¸ªé…ç½®ç±»
- æ¯ä¸ªç»„ä»¶åªç®¡ç†è‡ªå·±çš„é…ç½®åˆ†åŒº
- ä½¿ç”¨ç‹¬ç«‹æ–‡ä»¶å­˜å‚¨

**å®ç°ç¤ºä¾‹ï¼š**
```csharp
// çª—å£é…ç½®
public class WindowConfig
{
    public double WindowWidth { get; set; }
    public double WindowHeight { get; set; }
    public bool IsMaximized { get; set; }
}

// åˆ—é…ç½®
public class ColumnConfig
{
    public double ColTagsWidth { get; set; }
    public double ColNotesWidth { get; set; }
    public string ColumnOrder { get; set; }
}

// åˆ†åŒºç®¡ç†å™¨
public class ConfigPartitionManager
{
    public static void SaveWindowConfig(WindowConfig config)
    {
        var json = JsonSerializer.Serialize(config);
        File.WriteAllText("AppData/window_config.json", json);
    }
    
    public static WindowConfig LoadWindowConfig()
    {
        // ...
    }
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… é…ç½®åˆ†ç¦»ï¼Œå‡å°‘å†²çª
- âœ… æ›´æ¸…æ™°çš„èŒè´£åˆ’åˆ†

**ç¼ºç‚¹ï¼š**
- â— é…ç½®æ–‡ä»¶å˜å¤š
- â— å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½éœ€è¦æ›´æ–°
- â— ä»éœ€é‡æ„å¤§éƒ¨åˆ†ä»£ç 

---

#### æ–¹æ¡ˆCï¼šæœ€å°æ”¹åŠ¨æ–¹æ¡ˆï¼ˆå½“å‰é‡‡ç”¨ï¼‰

**å·²å®ç°çš„ä¿®å¤ï¼š**
1. âœ… ç§»é™¤ `SettingsOverlayController.Hide()` ä¸­çš„ `SaveAllSettings()`
2. âœ… `ColumnService` ä¸å†ä¿å­˜ Tags/Notes åˆ—å®½åº¦
3. âœ… è®¾ç½®é¢æ¿å®æ—¶ä¿å­˜ï¼ˆLostFocusï¼‰ï¼Œä¸åœ¨å…³é—­æ—¶ä¿å­˜

**ä»éœ€æ”¹è¿›ï¼š**
- âš ï¸ æ·»åŠ é…ç½®é¡¹æ‰€æœ‰æƒæ–‡æ¡£
- âš ï¸ åœ¨`AppConfig`ç±»ä¸­æ·»åŠ æ³¨é‡Šè¯´æ˜æ¯ä¸ªå±æ€§çš„ç®¡ç†è€…

---

### 4.2 è®¾ç½®é¢æ¿æ‰©å±•æ¨¡å¼

**æ ‡å‡†è®¾ç½®é¢æ¿å®ç°æ¨¡æ¿ï¼š**

```csharp
public partial class NewSettingsPanel : UserControl, ISettingsPanel
{
    private bool _isLoadingSettings;
    
    public event EventHandler SettingsChanged;
    
    public NewSettingsPanel()
    {
        InitializeComponent();
        // ä¸åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ LoadSettings()
    }
    
    public void LoadSettings()
    {
        _isLoadingSettings = true;
        try
        {
            var config = ConfigManager.Load();
            // å¡«å……UIæ§ä»¶
            MyTextBox.Text = config.MySetting.ToString();
        }
        finally
        {
            _isLoadingSettings = false;
        }
    }
    
    public void SaveSettings()
    {
        // å½“å‰æ–¹æ¡ˆï¼šä¸å®ç°æ­¤æ–¹æ³•
        // ä½¿ç”¨å®æ—¶ä¿å­˜ä»£æ›¿
    }
    
    private void MyTextBox_LostFocus(object sender, RoutedEventArgs e)
    {
        if (_isLoadingSettings) return;
        
        if (int.TryParse(MyTextBox.Text, out int value))
        {
            ApplyMySetting(value);
        }
    }
    
    private void ApplyMySetting(int value)
    {
        var config = ConfigManager.Load();
        config.MySetting = value;
        ConfigManager.Save(config);
        
        SettingsChanged?.Invoke(this, EventArgs.Empty);
    }
}
```

**æœ€ä½³å®è·µï¼š**
1. **å®æ—¶ä¿å­˜**ï¼šåœ¨ LostFocus æˆ–å€¼æ”¹å˜æ—¶ç«‹å³ä¿å­˜
2. **ä¸åœ¨æ„é€ å‡½æ•°ä¸­åŠ è½½**ï¼šç”± `SettingsPanelControl.LoadCategory()` è°ƒç”¨
3. **æ ‡å¿—ä½é˜²æ­¢é€’å½’**ï¼š`_isLoadingSettings` é¿å…åŠ è½½æ—¶è§¦å‘ä¿å­˜
4. **è§¦å‘äº‹ä»¶é€šçŸ¥**ï¼š`SettingsChanged` è®©å…¶ä»–ç»„ä»¶å“åº”
5. **é…ç½®é¡¹æ–‡æ¡£**ï¼šåœ¨ä»£ç æ³¨é‡Šè¯´æ˜ç®¡ç†å“ªäº›é…ç½®é¡¹

---

### 4.3 æœªæ¥æ‰©å±•è®¡åˆ’

#### 4.3.1 é…ç½®é¡¹æ‰€æœ‰æƒæ–‡æ¡£

åœ¨ `AppConfig` ç±»ä¸­æ·»åŠ æ³¨é‡Šï¼š

```csharp
public class AppConfig
{
    // === çª—å£çŠ¶æ€ (WindowStateManager) ===
    public double WindowWidth { get; set; } = 1200;
    public double WindowHeight { get; set; } = 800;
    public bool IsMaximized { get; set; } = false;
    
    // === å¸ƒå±€ (WindowStateManager) ===
    public double ColLeftWidth { get; set; } = 300;
    public double ColCenterWidth { get; set; } = 850;
    
    // === æ–‡ä»¶åˆ—è¡¨åˆ—å®½ (FileListSettingsPanel) ===
    /// <summary>
    /// æ ‡ç­¾åˆ—å®½åº¦
    /// ç®¡ç†è€…: FileListSettingsPanel
    /// ä¸è¦åœ¨å…¶ä»–åœ°æ–¹ä¿®æ”¹ï¼
    /// </summary>
    public double ColTagsWidth { get; set; } = 150;
    
    /// <summary>
    /// å¤‡æ³¨åˆ—å®½åº¦
    /// ç®¡ç†è€…: FileListSettingsPanel
    /// ä¸è¦åœ¨å…¶ä»–åœ°æ–¹ä¿®æ”¹ï¼
    /// </summary>
    public double ColNotesWidth { get; set; } = 200;
    
    // ...
}
```

#### 4.3.2 é…ç½®éªŒè¯

æ·»åŠ é…ç½®éªŒè¯å±‚ï¼š

```csharp
public class ConfigValidator
{
    public static bool Validate(AppConfig config, out List<string> errors)
    {
        errors = new List<string>();
        
        if (config.ColTagsWidth < 50 || config.ColTagsWidth > 800)
            errors.Add("ColTagsWidth must be between 50 and 800");
            
        if (config.WindowWidth < 800)
            errors.Add("WindowWidth must be at least 800");
            
        return errors.Count == 0;
    }
}
```

#### 4.3.3 é…ç½®å˜æ›´ç›‘å¬

```csharp
public class ConfigChangeNotifier
{
    public event EventHandler<ConfigChangedEventArgs> ConfigChanged;
    
    public void NotifyChange(string propertyName, object oldValue, object newValue)
    {
        ConfigChanged?.Invoke(this, new ConfigChangedEventArgs
        {
            PropertyName = propertyName,
            OldValue = oldValue,
            NewValue = newValue
        });
    }
}
```

---

## 5. è¿ç§»è·¯çº¿å›¾

### é˜¶æ®µ1ï¼šæ–‡æ¡£å’Œè§„èŒƒï¼ˆ1å‘¨ï¼‰
- [ ] å®Œæˆé…ç½®é¡¹æ‰€æœ‰æƒæ–‡æ¡£
- [ ] ç¼–å†™è®¾ç½®é¢æ¿å¼€å‘æŒ‡å—
- [ ] ä»£ç å®¡æŸ¥ç°æœ‰è®¾ç½®é¢æ¿

### é˜¶æ®µ2ï¼šæ ¸å¿ƒé‡æ„ï¼ˆ2-3å‘¨ï¼‰
- [ ] å®ç° `ConfigurationManager` å•ä¾‹
- [ ] é‡æ„ `FileListSettingsPanel` ä½¿ç”¨æ–°API
- [ ] é‡æ„ `WindowStateManager` ä½¿ç”¨æ–°API
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### é˜¶æ®µ3ï¼šå…¨é¢è¿ç§»ï¼ˆ2å‘¨ï¼‰
- [ ] è¿ç§»æ‰€æœ‰è®¾ç½®é¢æ¿
- [ ] è¿ç§» `ConfigService`
- [ ] è¿ç§» `ColumnService`
- [ ] é›†æˆæµ‹è¯•

### é˜¶æ®µ4ï¼šä¼˜åŒ–å’Œæ¸…ç†ï¼ˆ1å‘¨ï¼‰
- [ ] ç§»é™¤æ—§çš„ `ConfigManager.Save()` ç›´æ¥è°ƒç”¨
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£æ›´æ–°

---

## 6. å…³é”®å†³ç­–è®°å½•

### å†³ç­–1ï¼šä¸ºä»€ä¹ˆç§»é™¤ SaveAllSettings()ï¼Ÿ
**æ—¥æœŸï¼š** 2025-12-23

**é—®é¢˜ï¼š** å…³é—­è®¾ç½®æ—¶è°ƒç”¨ `SaveAllSettings()` å¯¼è‡´å½“å‰é¢æ¿è¦†ç›–å…¶ä»–é¢æ¿çš„é…ç½®

**å†³ç­–ï¼š** ç§»é™¤ `SettingsOverlayController.Hide()` ä¸­çš„è°ƒç”¨

**ç†ç”±ï¼š**
- å„è®¾ç½®é¢æ¿å·²å®ç°å®æ—¶ä¿å­˜
- å…³é—­æ—¶ä¿å­˜æ˜¯å†—ä½™çš„
- é¿å…Load-Modify-Saveå†²çª

**å½±å“ï¼š**
- âœ… è§£å†³äº† Notes åˆ—å®½åº¦é‡å¯åæ¢å¤çš„é—®é¢˜
- âš ï¸ éœ€è¦ç¡®ä¿æ‰€æœ‰é¢æ¿éƒ½å®ç°äº†å®æ—¶ä¿å­˜

---

### å†³ç­–2ï¼šåˆ—å®½åº¦ç”±è°ç®¡ç†ï¼Ÿ
**æ—¥æœŸï¼š** 2025-12-23

**å†³ç­–ï¼š** Tags å’Œ Notes åˆ—å®½åº¦ä¸“ç”± `FileListSettingsPanel` ç®¡ç†

**å®ç°ï¼š**
- `ColumnService.SaveColumnWidths()` è·³è¿‡ Tags/Notes
- `ColumnService.RememberColumnWidth()` è·³è¿‡ Tags/Notes
- `FileListSettingsPanel.ApplyNotesWidth()` è´Ÿè´£ä¿å­˜

**ç†ç”±ï¼š**
- è®¾ç½®é¢æ¿æ˜¯ç”¨æˆ·æ˜¾å¼ä¿®æ”¹çš„åœ°æ–¹
- `ColumnService` çš„ä¿å­˜æ˜¯éšå¼çš„ï¼ˆæ‹–æ‹½åˆ—æ ‡é¢˜ï¼‰
- æ˜¾å¼æ„å›¾åº”ä¼˜å…ˆäºéšå¼è¡Œä¸º

---

## 7. é™„å½•

### é™„å½•Aï¼šé…ç½®æ–‡ä»¶ç»“æ„

**æ–‡ä»¶ï¼š** `AppData/ooi_config.json`

```json
{
  "WindowWidth": 1200,
  "WindowHeight": 800,
  "IsMaximized": true,
  "ColLeftWidth": 300,
  "ColCenterWidth": 850,
  "ColRightWidth": 720,
  "ColNameWidth": 200,
  "ColSizeWidth": 100,
  "ColTypeWidth": 100,
  "ColModifiedDateWidth": 150,
  "ColCreatedTimeWidth": 50,
  "ColTagsWidth": 150,
  "ColNotesWidth": 200,
  "ColumnOrder": "Name,Size,Type,ModifiedDate,CreatedTime,Tags,Notes",
  "VisibleColumns_Path": "Name,Size,Type,ModifiedDate,Tags,Notes",
  "VisibleColumns_Library": "Name,Size,Type,ModifiedDate,Tags,Notes",
  "VisibleColumns_Tag": "Name,Size,Type,ModifiedDate",
  "SortColumn": "Name",
  "SortDirection": "Ascending",
  "LastPath": "C:\\Users\\...",
  "LastLibraryId": 1,
  "OpenTabs": ["path:C:\\...", "library:1", "tag:æ›œå"],
  "ActiveTabKey": "path:C:\\...",
  "DarkMode": false,
  "ActionButtons": ["home", "back", "forward"]
}
```

### é™„å½•Bï¼šç›¸å…³æ–‡ä»¶æ¸…å•

#### è®¾ç½®é¢æ¿
- [`Controls/SettingsPanelControl.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/SettingsPanelControl.xaml.cs) - è®¾ç½®UIå®¹å™¨
- [`Controls/Settings/GeneralSettingsPanel.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/Settings/GeneralSettingsPanel.xaml.cs)
- [`Controls/Settings/FileListSettingsPanel.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/Settings/FileListSettingsPanel.xaml.cs)
- [`Controls/Settings/LibrarySettingsPanel.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/Settings/LibrarySettingsPanel.xaml.cs)
- [`Controls/Settings/PathSettingsPanel.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/Settings/PathSettingsPanel.xaml.cs)
- [`Controls/Settings/TagSettingsPanel.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/Settings/TagSettingsPanel.xaml.cs)
- [`Controls/Settings/TagTrainSettingsPanel.xaml.cs`](file:///f:/Download/GitHub/OoiMRR/Controls/Settings/TagTrainSettingsPanel.xaml.cs)

#### é…ç½®ç®¡ç†
- [`Services/Core/ConfigManager.cs`](file:///f:/Download/GitHub/OoiMRR/Services/Core/ConfigManager.cs) - é…ç½®æ–‡ä»¶I/O
- [`Services/Core/Config/ConfigService.cs`](file:///f:/Download/GitHub/OoiMRR/Services/Core/Config/ConfigService.cs) - é…ç½®åº”ç”¨æœåŠ¡

#### çŠ¶æ€ç®¡ç†
- [`Services/UI/WindowStateManager.cs`](file:///f:/Download/GitHub/OoiMRR/Services/UI/WindowStateManager.cs) - çª—å£çŠ¶æ€
- [`Services/UI/NavigationStateManager.cs`](file:///f:/Download/GitHub/OoiMRR/Services/UI/NavigationStateManager.cs) - å¯¼èˆªçŠ¶æ€

#### å…¶ä»–
- [`Services/UI/Settings/SettingsOverlayController.cs`](file:///f:/Download/GitHub/OoiMRR/Services/UI/Settings/SettingsOverlayController.cs) - è®¾ç½®æ˜¾ç¤ºæ§åˆ¶
- [`Services/UI/ColumnManagement/ColumnService.cs`](file:///f:/Download/GitHub/OoiMRR/Services/UI/ColumnManagement/ColumnService.cs) - åˆ—ç®¡ç†
- [`Handlers/WindowLifecycleHandler.cs`](file:///f:/Download/GitHub/OoiMRR/Handlers/WindowLifecycleHandler.cs) - çª—å£ç”Ÿå‘½å‘¨æœŸ

---

## 8. æ€»ç»“

å½“å‰çš„è®¾ç½®ç³»ç»ŸåŠŸèƒ½å®Œæ•´ï¼Œä½†å­˜åœ¨é…ç½®å†²çªçš„ç³»ç»Ÿæ€§é—®é¢˜ã€‚é€šè¿‡ç§»é™¤å†—ä½™çš„ä¿å­˜è°ƒç”¨å’Œæ˜ç¡®èŒè´£åˆ†å·¥ï¼Œæˆ‘ä»¬å·²ç»ä¿®å¤äº†æœ€ç´§æ€¥çš„é—®é¢˜ã€‚

**ä¸‹ä¸€æ­¥å»ºè®®ï¼š**
1. ğŸ“ æ·»åŠ é…ç½®é¡¹æ‰€æœ‰æƒæ–‡æ¡£ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
2. ğŸ—ï¸ å®ç° `ConfigurationManager` ç»Ÿä¸€é…ç½®ç®¡ç†ï¼ˆä¸­æœŸç›®æ ‡ï¼‰
3. âœ… ä¸ºæ‰€æœ‰è®¾ç½®é¢æ¿æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆé•¿æœŸç›®æ ‡ï¼‰

**ç»´æŠ¤å»ºè®®ï¼š**
- æ–°å¢è®¾ç½®æ—¶ï¼Œå…ˆåœ¨ `AppConfig` ä¸­æ³¨é‡Šå£°æ˜æ‰€æœ‰æƒ
- ä½¿ç”¨å®æ—¶ä¿å­˜æ¨¡å¼ï¼Œé¿å…åœ¨ `SaveSettings()` ä¸­ä¿å­˜
- å®šæœŸå®¡æŸ¥é…ç½®ä¿å­˜è°ƒç”¨ç‚¹ï¼Œç¡®ä¿ä¸ä¼šäº’ç›¸å†²çª
