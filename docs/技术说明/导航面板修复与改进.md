# 导航面板修复与改进技术文档

**日期**: 2026-02-06
**相关模块**: NavigationPanelControl, MainWindow, DragDrop, ConfigManager

## 1. 概述

本次更新主要修复了导航面板（左侧边栏）的交互问题，增强了文件操作支持，并添加了布局状态的持久化功能。

## 2. 详细变更

### 2.1 修复导航交互 (左键点击无效问题)

**问题描述**: 
之前版本中，"快速访问" (Quick Access) 和 "收藏夹" (Favorites) 列表在单击选中时无法触发导航，必须双击或通过其他方式触发。

**解决方案**:
- 在 `NavigationPanelControl` 中公开了 `SelectionChanged` 事件。
- 在 `MainWindow.Initialization.cs` 中订阅了 `QuickAccessListBoxSelectionChanged` 和 `FavoriteListBoxSelectionChanged`。
- 实现了对应的事件处理逻辑，通过 `NavigationCoordinator` 统一处理导航请求。
- 确保了 `LibrariesListBox` 的选择变更也能正确触发导航。

### 2.2 实现导航面板拖拽支持 (Drag & Drop)

**功能目标**: 
允许用户将文件拖拽到导航面板的各个区域（如某个库、某个收藏夹路径或驱动器）以执行复制/移动操作。

**实现细节**:
- **初始化**: 在 `MainWindow.DragDrop.cs` 中新增 `InitializeNavigationPanelDragDrop` 方法。
- **目标解析**: 实现了 `GetPathFromDragTarget` 方法，通过可视化树(`VisualTreeHelper`)查找拖拽目标的 `DataContext`，并解析出目标路径：
    - **库 (Library)**: 自动解析为 `lib://Name` 并转换为库包含的第一个物理路径作为目标。
    - **收藏 (Favorite)**: 直接获取 `Favorite.Path`。
    - **快速访问/驱动器 (FileSystemItem)**: 通过反射获取 `Path` 属性。
- **操作集成**: 集成现有的 `DragDropManager`，支持通过 Ctrl 键切换复制/移动模式。

### 2.3 侧边栏折叠状态持久化

**问题描述**: 
用户调整侧边栏（如折叠"驱动器"或"快速访问"）后，重启应用状态会重置。

**解决方案**:
- **配置存储**: 在 `AppConfig` (ConfigManager.cs) 中新增 `SidebarExpanderStates` 字典。
- **状态监听**: 在 `NavigationPanelControl.xaml.cs` 中添加 `AttachSaveListener`，监听 `Expander` 的 `Expanded` 和 `Collapsed` 事件。
- **自动保存**: 状态变更时自动更新配置，并通过 `ConfigurationService` 的去抖机制保存到磁盘。
- **加载恢复**: 控件加载时调用 `LoadExpanderStates` 恢复上次的状态。

## 3. 代码影响

- Modified: `Controls/NavigationPanelControl.xaml.cs` (Added Events, Persistence Logic)
- Modified: `MainWindow.Initialization.cs` (Event Wiring)
- Modified: `MainWindow.DragDrop.cs` (New DragDrop Logic)
- Modified: `MainWindow.Favorites.cs` / `MainWindow.QuickAccess.cs` (Selection Handlers)
- Modified: `Services/Core/ConfigManager.cs` (New Config Property)

## 4. 后续计划

- 进一步优化库拖拽逻辑，支持拖入库中的特定文件夹（目前默认拖入第一个文件夹）。
- 完善 Tag 面板的拖拽支持。
