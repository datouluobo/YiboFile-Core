# å¤‡æ³¨æ¨¡å— (Notes Module) ç°ä»£åŒ–æ¶æ„è®¾è®¡

## æ¦‚è¿°

å¤‡æ³¨æ¨¡å—æ˜¯æœ¬é¡¹ç›®é¦–ä¸ªé‡‡ç”¨å®Œå…¨ç°ä»£åŒ–æ¶æ„é‡æ„çš„æ¨¡å—ï¼Œç”¨äºéªŒè¯å’Œå±•ç¤ºæœ€ä½³å®è·µã€‚
è¯¥æ¶æ„å¯ä½œä¸ºåç»­æ¨¡å—ï¼ˆå¦‚æ ‡ç­¾ã€æ”¶è—å¤¹ã€åº“ç®¡ç†ï¼‰é‡æ„çš„å‚è€ƒæ¨¡æ¿ã€‚

## æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     UI å±‚ (View)                             â”‚
â”‚  FileNotesUIHandler.cs, RightPanelControl                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ æ¶ˆæ¯æ€»çº¿
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ViewModel å±‚ (Module)                       â”‚
â”‚  NotesModule.cs                                              â”‚
â”‚  - è®¢é˜…æ¶ˆæ¯: GetNotes, SaveNotes, DeleteNotes, Search       â”‚
â”‚  - å‘å¸ƒæ¶ˆæ¯: NotesLoaded, NotesUpdated                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ ä¾èµ–æ³¨å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ (Service)                           â”‚
â”‚  INotesService / NotesService                                â”‚
â”‚  - ä¸šåŠ¡é€»è¾‘å°è£…                                              â”‚
â”‚  - äº‹ä»¶è§¦å‘ (NotesUpdated)                                   â”‚
â”‚  - æ‘˜è¦ç”Ÿæˆã€æ‰¹é‡æ“ä½œç­‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ æ¥å£æŠ½è±¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®è®¿é—®å±‚ (Repository)                     â”‚
â”‚  INotesRepository / SqliteNotesRepository                    â”‚
â”‚  - CRUD æ“ä½œ                                                 â”‚
â”‚  - FTS5 å…¨æ–‡æœç´¢                                             â”‚
â”‚  - æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®åº“ (SQLite)                           â”‚
â”‚  FileNotes è¡¨ + FileNotesFts è™šæ‹Ÿè¡¨                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–‡ä»¶ç»“æ„

```
Services/
â”œâ”€â”€ Data/
â”‚   â””â”€â”€ Repositories/
â”‚       â”œâ”€â”€ INotesRepository.cs        # æ¥å£å®šä¹‰
â”‚       â””â”€â”€ SqliteNotesRepository.cs   # SQLite å®ç°
â””â”€â”€ Features/
    â””â”€â”€ FileNotes/
        â”œâ”€â”€ NotesService.cs            # ä¸šåŠ¡æœåŠ¡å±‚
        â”œâ”€â”€ INotesService.cs           # (åœ¨ NotesService.cs å†…)
        â””â”€â”€ FileNotesUIHandler.cs      # UI äº‹ä»¶å¤„ç†

ViewModels/
â”œâ”€â”€ Modules/
â”‚   â””â”€â”€ NotesModule.cs                 # MVVM æ¨¡å—
â””â”€â”€ Messaging/
    â””â”€â”€ Messages/
        â””â”€â”€ NotesMessages.cs           # æ¶ˆæ¯å®šä¹‰
```

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. æ¥å£æŠ½è±¡ (INotesRepository)
- å®šä¹‰æ¸…æ™°çš„æ•°æ®è®¿é—®å¥‘çº¦
- ä¾¿äºå•å…ƒæµ‹è¯•ï¼ˆå¯ Mockï¼‰
- æ”¯æŒå¤šç§å®ç°ï¼ˆSQLiteã€æ–‡ä»¶ã€äº‘å­˜å‚¨ç­‰ï¼‰

### 2. ä¾èµ–æ³¨å…¥ (DI)
åœ¨ `App.xaml.cs` ä¸­æ³¨å†Œï¼š
```csharp
services.AddSingleton<INotesRepository, SqliteNotesRepository>();
services.AddSingleton<INotesService, NotesService>();
```

### 3. æ¶ˆæ¯é©±åŠ¨ (Message Bus)
UI ä¸ ViewModel é€šè¿‡æ¶ˆæ¯è§£è€¦ï¼š
- `GetNotesRequestMessage` â†’ è¯·æ±‚åŠ è½½å¤‡æ³¨
- `SaveNotesRequestMessage` â†’ è¯·æ±‚ä¿å­˜å¤‡æ³¨
- `NotesLoadedMessage` â†’ å¤‡æ³¨åŠ è½½å®Œæˆé€šçŸ¥
- `NotesUpdatedMessage` â†’ å¤‡æ³¨æ›´æ–°é€šçŸ¥

### 4. å‘åå…¼å®¹
`FileNotesUIHandler` æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
- **æ–°æ¶æ„**: é€šè¿‡ `INotesService` æ“ä½œ
- **æ—§æ¶æ„**: å›é€€è‡³ `FileNotesService` é™æ€ç±»

## ä½¿ç”¨æ–¹å¼

### æ–¹å¼ä¸€ï¼šé€šè¿‡æ¶ˆæ¯æ€»çº¿
```csharp
// ä¿å­˜å¤‡æ³¨
_messageBus.Publish(new SaveNotesRequestMessage(filePath, notes));

// è®¢é˜…åŠ è½½å®Œæˆ
_messageBus.Subscribe<NotesLoadedMessage>(msg => {
    textBox.Text = msg.Notes;
});
```

### æ–¹å¼äºŒï¼šé€šè¿‡ NotesModule ç›´æ¥è°ƒç”¨
```csharp
var notesModule = _viewModel.Notes;
await notesModule.SaveNotesAsync(filePath, notes);
var summary = notesModule.GetSummary(notes);
```

### æ–¹å¼ä¸‰ï¼šé€šè¿‡ DI è·å–æœåŠ¡
```csharp
var notesService = App.ServiceProvider.GetService<INotesService>();
var notes = await notesService.GetNotesAsync(filePath);
```

## æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡è·å–
```csharp
// ä¸€æ¬¡æŸ¥è¯¢å¤šä¸ªæ–‡ä»¶çš„å¤‡æ³¨
var notesBatch = await notesModule.GetNotesBatchAsync(filePaths);
```

### FTS5 å…¨æ–‡æœç´¢
- ä¸­æ–‡é€å­—å‰ç¼€åŒ¹é…
- è‹±æ–‡å•è¯å‰ç¼€åŒ¹é…
- è‡ªåŠ¨ LIKE å›é€€

## åç»­æ¨¡å—è¿ç§»è®¡åˆ’

| æ¨¡å— | æ¥å£ | å®ç° | çŠ¶æ€ |
|------|------|------|------|
| å¤‡æ³¨ | INotesRepository | SqliteNotesRepository | âœ… å®Œæˆ |
| æ ‡ç­¾ | ITagsRepository | SqliteTagsRepository | ğŸ“‹ å¾…å¼€å‘ |
| æ”¶è—å¤¹ | IFavoritesRepository | SqliteFavoritesRepository | ğŸ“‹ å¾…å¼€å‘ |
| åº“ç®¡ç† | ILibraryRepository | SqliteLibraryRepository | ğŸ“‹ å¾…å¼€å‘ |

## æµ‹è¯•å»ºè®®

ç”±äºé‡‡ç”¨äº†æ¥å£æŠ½è±¡ï¼Œå¯ä»¥è½»æ¾ç¼–å†™å•å…ƒæµ‹è¯•ï¼š

```csharp
[TestClass]
public class NotesServiceTests
{
    [TestMethod]
    public async Task SaveAndLoad_ShouldReturnSameContent()
    {
        var mockRepo = new Mock<INotesRepository>();
        mockRepo.Setup(r => r.GetNotes("test.txt")).Returns("Hello");
        
        var service = new NotesService(mockRepo.Object);
        var notes = service.GetNotes("test.txt");
        
        Assert.AreEqual("Hello", notes);
    }
}
```

---
*æ–‡æ¡£ç‰ˆæœ¬: 1.0*
*æœ€åæ›´æ–°: 2026-01-25*
