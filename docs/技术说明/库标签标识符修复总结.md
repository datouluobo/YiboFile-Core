# 库标签标识符与协议头显示修复总结

## 1. 问题描述
在用户界面中，当用户切换到“库”（Library）标签页时，地址栏和面包屑导航应显示库的专用标识符（如 `lib 图片`），而不是底层的物理路径。

**存在的问题：**
1.  地址栏经常错误地显示为普通文件路径（例如 `D:\Media\Images`）。
2.  地址栏文本缺少 `lib://` 协议头，导致系统将其误判为普通文件夹。
3.  ViewModel 的导航模式（NavigationMode）与 UI 状态偶尔不同步。

## 2. 根本原因分析
经过排查，发现主要原因在于 MVVM 状态与遗留代码（Legacy Code）之间的同步机制存在缺陷：

1.  **状态不同步**：在 `MainWindow.Initialization.cs` 的 `SyncUiWithActiveTab` 方法中，当切换标签页时，仅更新了旧的字段（`_currentLibrary`），而未更新 `PaneViewModel` 的状态。这导致 ViewModel 仍保持在 "Path" 模式，进而向 UI 推送普通路径更新，覆盖了库的显示。
2.  **协议头缺失**：`PaneViewModel` 在设置库时，未强制将 `CurrentPath` 格式化为 `lib://` 形式。
3.  **显示逻辑不一致**：`AddressBarControl` 中使用的标识符字符串为 "library "，而期望的是 "lib "。

## 3. 解决方案与修改内容

### 3.1 核心修复：强制 ViewModel 状态同步
**文件**：`MainWindow.Initialization.cs`

在 `SyncUiWithActiveTab` 方法中，增加了对 ViewModel 的显式调用。当检测到标签页类型为 Library 时，强制 ViewModel 导航到该库，从而更新其内部的 `NavigationMode` 和 `CurrentPath`。

```csharp
if (tab.Library != null)
{
    HighlightMatchingLibrary(tab.Library);
    // [修复] 确保 ViewModel 更新为 Library 模式，以便 UI 正确绑定
    _viewModel?.PrimaryPane?.NavigateTo(tab.Library, loadData: false);
    LoadLibraryFiles(tab.Library);
}
```

### 3.2 确保协议头正确
**文件**：`ViewModels/PaneViewModel.cs`

在 `NavigateTo(Library library)` 方法中，显式设置带有协议头的路径：

```csharp
NavigationMode = "Library";
// [修复] 确保 CurrentPath 包含协议头，以便地址栏正确识别模式
CurrentPath = $"lib://{library.Name}";
```

同时，在 `CurrentPath` 的设置器中，增加了当切换回普通路径时自动清除 Library/Tag 状态的逻辑，防止状态残留。

### 3.3 UI 显示逻辑修正
**文件**：`Controls/FileBrowserControl.xaml.cs`
*   优化了 `RefreshBreadcrumbFromViewModel`，优先处理 Path 模式，防止旧的 Library 状态干扰。
*   在 Library 模式下，强制地址栏文本显示为 `lib://` 格式。

**文件**：`Controls/AddressBarControl.xaml.cs`
*   将显示的标识符从 "library " 修改为 "lib "，以保持一致性。

## 4. 结果验证
经过修复，系统表现如下：
*   **切换标签页**：点击库标签页时，地址栏立即更新为 `lib 库名`。
*   **地址文本**：进入编辑模式查看，地址显示为 `lib://库名`。
*   **状态一致性**：ViewModel 的 `NavigationMode` 正确切换为 "Library"，避免了 UI 闪烁或错误回退到物理路径的问题。

本次修复彻底解决了库标签页显示不稳定的问题，加强了 MVVM 模式在混合架构中的数据流控制。
