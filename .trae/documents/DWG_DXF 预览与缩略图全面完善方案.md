## 现状概述
- 路由：`.dwg`/`.dxf` 在 `Previews/PreviewFactory.cs:86-99` 被路由到 `CadPreview`。
- 预览：`CadPreview.cs:18` 仅提供两种方式：打开本地查看器(`FindCadViewer` 入口 `CadPreview.cs:154`)或用 `WebView2` 加载说明页(`GenerateCadViewerHtml` `CadPreview.cs:180`)，无内置渲染。
- 缩略图：`Controls/Converters/ThumbnailConverter.cs:231` 通过 `GetShellThumbnail`(`ThumbnailConverter.cs:438`)获取 Windows Shell 缓存，失败则回退系统图标(`GetHighQualitySystemIcon`)；不生成自有 CAD 缩略图。
- 平台：项目为 `net8.0-windows` + WPF，仅支持 Windows；无 Linux 支撑层。

## 改造目标
- 完整支持 DWG/DXF 预览与一致尺寸的缩略图生成，覆盖常见 AutoCAD 版本与复杂图元。
- 提供稳定、快速、可控的预览与缩略图管线，具备错误反馈与回退策略。
- 在 Windows 和 Linux 上均可进行兼容性与压力测试（Linux 以跨平台渲染库与 CLI 测试支架达成）。
- 保持向后兼容：外部查看器路径与现有行为保留为回退选项。

## 技术路线
- 架构抽象：在现有 `CadPreview` 基础上增加“内嵌渲染”分支，形成三层管线：文件 → 布局枚举 → 渲染到位图 → UI/缩略图缓存。
- DXF 内置渲染：采用 `IxMilia.Dxf` 解析 + `SkiaSharp` 绘制（跨平台），支持常见实体、图层、块引用、线型、颜色、文字。
- DWG 支持策略：
  - 优先使用外部转换工具将 DWG 转 DXF/PNG（如 ODA File Converter/QCAD 导出，具体工具以配置方式注入），再走统一渲染与缩略图管线。
  - 保留外部查看器作为预览回退；在无法转换或解析时自动回退。
- 多页/布局：枚举 Model/Paper 空间与各 Layout，逐页渲染；预览界面提供页签/下拉选择。
- 缩略图统一：优先使用自有渲染生成 PNG，固定边长（如 256）与居中裁剪，落盘缓存；Shell 缩略图仅作为次级回退。
- 性能与内存：渐进式渲染（视口裁剪、LOD）、几何简化、纹理复用、图片缓存键包含 `路径+尺寸+最后修改时间`，并设定 TTL 与清理策略。
- 错误反馈：统一错误码与消息（解析错误、实体不支持、转换失败、内存不足等），UI 友好提示与日志记录。
- 跨平台测试支架：抽离渲染核心为 `netstandard`/`net8.0` 类库；新增跨平台 CLI（仅测试用）批量生成预览/缩略图以满足 Linux 测试要求。

## 具体改造项
### 1) 功能检查
- 枚举并记录当前支持范围：由 `FileTypeManager.cs:209-210` 和 `PreviewFactory.cs:86-99` 出发，梳理扩展与能力矩阵。
- 收集样本：不同 AutoCAD 版本的 DWG/DXF（2000/2007/2010/2013/2018/2024），复杂度分级（小/中/大/超大）。
- 质量指标：分辨率、抗锯齿、线型/线宽、颜色准确度、文字清晰度（设立像素差异阈值与颜色误差 ΔE）。
- 性能指标：缩略图生成耗时、中位数与 P95；预览渲染首屏时间；大文件内存峰值与 GC 行为。

### 2) 问题修复
- 预览异常（线条缺失、文字乱码）：完善 DXF 渲染通道（文字编码/字体映射、线型比例、块嵌套与变换、图层可见性）。
- 大文件性能：引入视口裁剪、分块渲染与几何简化；限制首屏对象数与曲线近似步长，后台逐步细化。
- 缩略图尺寸不一致：移除对 Shell 缩略图的主依赖，在 `ThumbnailConverter.cs:231` 先尝试自有渲染，固定输出尺寸；Shell 结果仅为回退。
- 特殊图层与块引用：解析层状态（开/关/冻结/锁定）、ByLayer 属性、嵌套块矩阵变换、裁剪边界；渲染时尊重层可见性与绘制顺序。

### 3) 功能完善
- 多页 DWG/DXF：枚举 Layout，预览提供页签/下拉，缩略图支持每页缩略或首页缩略；导出全部页为 PNG。
- 自定义实体与代理对象：对未知/不支持实体提供占位渲染（边界框/类型标注），日志记录；在能力允许范围内扩展常见代理。
- 内存管理：图片缓存上限、LRU 淘汰；大图按需释放；渲染过程尽量无分配（Span/池化）；避免 `System.Drawing` GDI 句柄泄漏。
- 错误反馈：在 `CadPreview` 嵌入渲染分支中加入错误面板；在缩略图转换处返回带状态的占位图，并写入日志文件。

### 4) 测试方案
- 平台：Windows（WPF UI 与 CLI）；Linux（CLI 批处理渲染）。
- 压力测试：构建 3 级复杂度与 4 个尺寸档位文件集（如 10MB/50MB/200MB/500MB），记录耗时与内存。
- 互操作性：使用 AutoCAD、DWG TrueView、BricsCAD、DraftSight、QCAD 对同文件进行对比；核验颜色、线宽、文字。
- 自动化与单元测试：
  - 解析单元：实体数/图层数/块层级等断言。
  - 渲染单元：快照生成后做像素 RMS/SSIM 阈值校验；多页渲染页数与命名一致性。
  - 性能回归：基准测试记录并设阈值；生成报告（CSV/JSON）。

### 5) 交付物
- 完整测试报告：功能覆盖、兼容性、性能与内存、互操作性结论与问题清单。
- 单元测试与基准：覆盖解析、渲染、缩略图、错误反馈与回退路径。
- 技术文档更新：渲染管线、支持范围、配置项（外部转换器/查看器）、缓存策略与清理机制。
- 向后兼容：保留 `FindCadViewer` 打开逻辑；当解析/渲染失败时自动回退到外部查看器或说明页。

## 代码变更点（不立即执行，仅规划）
- `Previews/CadPreview.cs:18`：新增“内嵌渲染”分支（DXF 原生、DWG 转换后渲染），并加入多页 UI 与错误反馈。
- `Previews/PreviewFactory.cs:86-99`：保留路由；若需要新增专用 `CadEmbeddedPreview`，此处改为按扩展选择具体提供者。
- `Controls/Converters/ThumbnailConverter.cs:231/438`：在 Shell 缩略图前插入 CAD 渲染缩略图尝试；统一尺寸与缓存（应用数据目录）。
- 新增渲染核心（最小必要）：`Rendering/DxfRenderEngine.cs`、`Rendering/CadLayoutEnumerator.cs`、`Services/CadImageCache.cs`（跨平台类库）。
- （测试支架）新增 CLI：`Tools/CadRenderCli`（跨平台生成 PNG 以供 Windows/Linux 测试）。

## 风险与依赖
- DWG 支持的法律与许可：若需直接 DWG 解析，通常依赖商用库（RealDWG/ODA）；本方案以“外部转换工具”与回退查看器满足需求。
- 渲染一致性：DXF 与 DWG 转 DXF 的表现差异需要测试与参数校准（线型比例、单位、文字替代字体）。
- 大文件性能：需要基于真实数据迭代调参（LOD、裁剪窗口、缓存大小）。

## 验收指标
- 缩略图：256×256（或配置值）统一，90%+ 文件成功生成；P95 耗时 ≤ 800ms（中等文件）。
- 预览：典型 50MB 文件首屏 ≤ 2s；多页切换 ≤ 300ms；内存峰值受控且无泄漏。
- 兼容性：覆盖主流 AutoCAD 版本；对不支持实体提供可见占位与错误提示；Windows 与 Linux 均完成测试。
- 互操作性：与主流 CAD 软件视觉差异在可接受阈值内（线宽/颜色/文字位置）。

如果同意以上方案，我将按上述“代码变更点”推进实现与测试。