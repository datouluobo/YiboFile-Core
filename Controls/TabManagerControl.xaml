<UserControl x:Class="YiboFile.Controls.TabManagerControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:shell="clr-namespace:System.Windows.Shell;assembly=PresentationFramework"
             mc:Ignorable="d" 
             d:DesignHeight="40" d:DesignWidth="800"
             shell:WindowChrome.IsHitTestVisibleInChrome="True">
    <UserControl.Resources>
        <!-- 滚动条滑块样式 -->
        <Style x:Key="TabScrollBarThumbStyle" TargetType="{x:Type Thumb}">
             <Setter Property="IsTabStop" Value="False"/>
             <Setter Property="Focusable" Value="False"/>
             <Setter Property="OverridesDefaultStyle" Value="True"/>
             <Setter Property="Template">
                 <Setter.Value>
                     <ControlTemplate TargetType="{x:Type Thumb}">
                         <Border Background="{TemplateBinding Background}" 
                                 CornerRadius="2" 
                                 BorderThickness="0"
                                 VerticalAlignment="Stretch"
                                 HorizontalAlignment="Stretch"
                                 MinWidth="40"/> <!-- 防止滑块太小 -->
                     </ControlTemplate>
                 </Setter.Value>
             </Setter>
        </Style>

        <!-- 滚动条样式：默认隐藏，悬停显示，悬停变粗 -->
        <Style x:Key="SmartScrollBarStyle" TargetType="{x:Type ScrollBar}">
            <Setter Property="Stylus.IsPressAndHoldEnabled" Value="false"/>
            <Setter Property="Stylus.IsFlicksEnabled" Value="false"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
            <Setter Property="Width" Value="Auto"/>
            <Setter Property="Height" Value="2.5"/> <!-- 默认高度 60% of 4 ~= 2.5 -->
            <Setter Property="MinHeight" Value="0"/> <!-- 关键：覆盖默认最小高度 -->
            <Setter Property="Opacity" Value="0"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollBar}">
                        <Grid x:Name="Bg" SnapsToDevicePixels="true" Background="Transparent">
                            <Track x:Name="PART_Track" IsDirectionReversed="false" IsEnabled="{TemplateBinding IsEnabled}">
                                <Track.DecreaseRepeatButton>
                                    <RepeatButton Command="{x:Static ScrollBar.LineLeftCommand}" Opacity="0" Width="0"/>
                                </Track.DecreaseRepeatButton>
                                <Track.IncreaseRepeatButton>
                                    <RepeatButton Command="{x:Static ScrollBar.LineRightCommand}" Opacity="0" Width="0"/>
                                </Track.IncreaseRepeatButton>
                                <Track.Thumb>
                                    <Thumb Style="{StaticResource TabScrollBarThumbStyle}" Background="{DynamicResource AccentDefaultBrush}"/>
                                </Track.Thumb>
                            </Track>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <!-- 绑定到父ScrollViewer的IsMouseOver (需要通过Ancestor查找)
                                 但ScrollBar在模板内，直接绑定较难。
                                 替代方案：在ScrollViewer的Trigger中修改ScrollBar的属性。
                            -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Height" Value="6"/> <!-- 悬停变粗 60% of 10 = 6 -->
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 自定义 ScrollViewer 模板 -->
        <Style x:Key="OverlayScrollViewerStyle" TargetType="{x:Type ScrollViewer}">
            <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
            <Setter Property="VerticalScrollBarVisibility" Value="Disabled"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type ScrollViewer}">
                        <Grid x:Name="Grid" Background="{TemplateBinding Background}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <!-- 内容区域 -->
                            <ScrollContentPresenter x:Name="PART_ScrollContentPresenter" 
                                                    CanContentScroll="{TemplateBinding CanContentScroll}" 
                                                    CanHorizontallyScroll="False" 
                                                    CanVerticallyScroll="False" 
                                                    ContentTemplate="{TemplateBinding ContentTemplate}" 
                                                    Content="{TemplateBinding Content}" 
                                                    Grid.Column="0" Grid.Row="0"
                                                    Margin="{TemplateBinding Padding}" />
                            
                            <!-- 水平滚动条：覆盖在底部 (Grid.Row=0, VerticalAlignment=Bottom) -->
                            <ScrollBar x:Name="PART_HorizontalScrollBar" 
                                       Orientation="Horizontal" 
                                       Grid.Row="0" Grid.Column="0"
                                       VerticalAlignment="Bottom"
                                       Style="{StaticResource SmartScrollBarStyle}"
                                       ViewportSize="{TemplateBinding ViewportWidth}" 
                                       Maximum="{TemplateBinding ScrollableWidth}" 
                                       Visibility="{TemplateBinding ComputedHorizontalScrollBarVisibility}" 
                                       Value="{Binding HorizontalOffset, Mode=OneWay, RelativeSource={RelativeSource TemplatedParent}}"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <!-- 当 ScrollViewer 悬停时，显示滚动条 -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="PART_HorizontalScrollBar" Property="Opacity" Value="1"/>
                            </Trigger>
                            <!-- 滚动条自身悬停时，也保持显示（逻辑包含在ScrollViewer悬停中，因为滚动条在内部） -->
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Border x:Name="TabsBorder" Background="Transparent" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0" Visibility="Visible"
            shell:WindowChrome.IsHitTestVisibleInChrome="True">
        <Grid Margin="8,4" shell:WindowChrome.IsHitTestVisibleInChrome="True">
            <!-- 标签页滚动区域 -->
            <ScrollViewer x:Name="TabScrollViewer" 
                          Style="{StaticResource OverlayScrollViewerStyle}"
                          PanningMode="HorizontalOnly"
                          shell:WindowChrome.IsHitTestVisibleInChrome="True">
                <StackPanel x:Name="TabsPanel" Orientation="Horizontal" shell:WindowChrome.IsHitTestVisibleInChrome="True"/>
            </ScrollViewer>
        </Grid>
    </Border>
</UserControl>

