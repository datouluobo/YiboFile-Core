<UserControl x:Class="YiboFile.Controls.FileBrowserControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:YiboFile.Controls"
             xmlns:helpers="clr-namespace:YiboFile.Helpers"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <helpers:BindingProxy x:Key="ControlProxy" Data="{Binding RelativeSource={RelativeSource AncestorType=controls:FileBrowserControl}}"/>
        <!-- ç»Ÿä¸€ä½¿ç”¨ AppStyles ä¸­çš„ ModernToolbarButtonStyle -->
        <Style x:Key="ToolbarButtonStyle" TargetType="Button" BasedOn="{StaticResource ModernToolbarButtonStyle}"/>
        
        <Style x:Key="ToolbarRadioButtonStyle" TargetType="RadioButton">
            <Setter Property="Height" Value="32"/>
            <Setter Property="Width" Value="32"/>
            <Setter Property="Padding" Value="6,0"/>
            <Setter Property="Margin" Value="1,0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
                                <Setter Property="Foreground" Value="{DynamicResource AccentBrush}"/>
                                <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- åˆ†æ®µæŒ‰é’®æ ·å¼ï¼ˆç”¨äºŽæœç´¢æ¨¡å¼åˆ‡æ¢ï¼‰ -->
        <Style x:Key="SegmentedButtonStyle" TargetType="RadioButton">
            <Setter Property="Height" Value="26"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundSecondaryBrush}"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}" 
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Background" Value="{DynamicResource AccentSubtleBrush}"/>
                                <Setter Property="Foreground" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        
        <!-- è¿‡æ»¤å™¨èŠ¯ç‰‡æ ·å¼ -->
        <Style x:Key="FilterChipStyle" TargetType="ToggleButton">
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="Margin" Value="1,0"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ToggleButton">
                        <Border x:Name="border"
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4" Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource ButtonHoverBackgroundBrush}"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter Property="Background" Value="{DynamicResource AccentSubtleBrush}"/>
                                <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                                <Setter Property="BorderThickness" Value="1"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <!-- æ–‡ä»¶å³é”®èœå• -->
        <ContextMenu x:Key="FileListContextMenu" Opened="FileListContextMenu_Opened">
            <MenuItem x:Name="CopyItem" Header="å¤åˆ¶" 
                      Command="{Binding Data.CopyCommand, Source={StaticResource ControlProxy}}" 
                      CommandParameter="{Binding Data.FilesSelectedItems, Source={StaticResource ControlProxy}}"
                      Icon="ðŸ“„"/>
            <MenuItem x:Name="CutItem" Header="å‰ªåˆ‡" 
                      Command="{Binding Data.CutCommand, Source={StaticResource ControlProxy}}" 
                      CommandParameter="{Binding Data.FilesSelectedItems, Source={StaticResource ControlProxy}}"
                      Icon="âœ‚ï¸"/>
            <MenuItem x:Name="PasteItem" Header="ç²˜è´´" 
                      Command="{Binding Data.PasteCommand, Source={StaticResource ControlProxy}}" 
                      CommandParameter="{Binding Data.DataContext, Source={StaticResource ControlProxy}}"
                      Icon="ðŸ“‹"/>
            <Separator x:Name="Separator1"/>
            <MenuItem x:Name="DeleteItem" Header="åˆ é™¤" 
                      Command="{Binding Data.DeleteCommand, Source={StaticResource ControlProxy}}" 
                      CommandParameter="{Binding Data.FilesSelectedItems, Source={StaticResource ControlProxy}}"
                      Icon="ðŸ—‘ï¸"/>
            <MenuItem x:Name="RenameItem" Header="é‡å‘½å" 
                      Command="{Binding Data.RenameCommand, Source={StaticResource ControlProxy}}" 
                      CommandParameter="{Binding Data.FilesSelectedItem, Source={StaticResource ControlProxy}}"
                      Icon="âœï¸"/>
            <Separator x:Name="Separator2"/>
            <MenuItem x:Name="AddFavoriteMenuItem" Header="â­ æ·»åŠ åˆ°æ”¶è—"/>
            <MenuItem x:Name="AddToLibraryMenuItem" Header="ðŸ“š æ·»åŠ åˆ°åº“"/>
            <MenuItem x:Name="AddTagMenuItem" Header="ðŸ·ï¸ æ·»åŠ æ ‡ç­¾"/>
            <Separator x:Name="Separator3"/>
            <MenuItem x:Name="RefreshItem" Header="åˆ·æ–°" 
                      Command="{Binding Data.RefreshCommand, Source={StaticResource ControlProxy}}" 
                      Icon="ðŸ”„"/>
            <MenuItem x:Name="PropertiesItem" Header="å±žæ€§" 
                      Command="{Binding Data.PropertiesCommand, Source={StaticResource ControlProxy}}" 
                      CommandParameter="{Binding Data.FilesSelectedItems, Source={StaticResource ControlProxy}}"
                      Icon="â„¹ï¸"/>
        </ContextMenu>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Row 0: åœ°å€æ  -->
            <RowDefinition Height="Auto"/>  <!-- Row 1: å·¥å…·æ è¡Œ -->
            <RowDefinition Height="Auto"/>  <!-- Row 2: æœç´¢çŠ¶æ€æç¤º -->
            <RowDefinition Height="*"/>     <!-- Row 3: æ–‡ä»¶åˆ—è¡¨ -->
            <RowDefinition Height="12"/>     <!-- Row 4: Splitter -->
            <RowDefinition Height="180" MinHeight="120"/> <!-- Row 5: Info Panel -->
        </Grid.RowDefinitions>

        <!-- Row 0: åœ°å€æ ï¼ˆçº¯åœ°å€è¾“å…¥ï¼‰ -->
        <Border Grid.Row="0" Background="Transparent" Margin="0,4,0,4">
            <controls:AddressBarControl x:Name="AddressBarControl" Margin="8,0" AddressText="{Binding CurrentPath, Mode=TwoWay}"/>
        </Border>
        
        <!-- Row 1: å·¥å…·æ è¡Œï¼ˆå¯¼èˆª + æ“ä½œ + è§†å›¾ + æœç´¢ï¼‰ -->
        <Border Grid.Row="1" Background="Transparent" Margin="0,0,0,4">
            <Grid Margin="8,2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>  <!-- å¯¼èˆªæŒ‰é’® -->
                    <ColumnDefinition Width="8"/>     <!-- é—´è· -->
                    <ColumnDefinition Width="Auto"/>  <!-- TitleActionBar -->
                    <ColumnDefinition Width="*"/>     <!-- å¡«å…… -->
                    <ColumnDefinition Width="Auto"/>  <!-- è§†å›¾åˆ‡æ¢ -->
                    <ColumnDefinition Width="8"/>     <!-- é—´è· -->
                    <ColumnDefinition Width="Auto"/>  <!-- æœç´¢/ç­›é€‰ -->
                </Grid.ColumnDefinitions>
                
                <!-- å¯¼èˆªæŒ‰é’® (â†â†’â†‘) -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Name="NavBackBtn" FontFamily="{DynamicResource IconFontFamily}" Content="{DynamicResource Icon_Back}" FontSize="14" Click="NavBackBtn_Click" ToolTip="åŽé€€" Style="{StaticResource ModernToolbarButtonStyle}"/>
                    <Button Name="NavForwardBtn" FontFamily="{DynamicResource IconFontFamily}" Content="{DynamicResource Icon_Forward}" FontSize="14" Click="NavForwardBtn_Click" ToolTip="å‰è¿›" Style="{StaticResource ModernToolbarButtonStyle}"/>
                    <Button Name="NavUpBtn" FontFamily="{DynamicResource IconFontFamily}" Content="{DynamicResource Icon_Up}" FontSize="14" Click="NavUpBtn_Click" ToolTip="å‘ä¸Š" Style="{StaticResource ModernToolbarButtonStyle}"/>
                    <!-- Undo/Redo -->
                    <Rectangle Width="1" Height="20" Fill="{DynamicResource BorderBrush}" Margin="4,0" VerticalAlignment="Center"/>
                    <Button Name="UndoBtn" FontFamily="Segoe MDL2 Assets" Content="&#xE7A7;" FontSize="14" 
                            Command="{Binding Data.UndoCommand, Source={StaticResource ControlProxy}}" 
                            ToolTip="æ’¤é”€" Style="{StaticResource ToolbarButtonStyle}"/>
                    <Button Name="RedoBtn" FontFamily="Segoe MDL2 Assets" Content="&#xE7A6;" FontSize="14" 
                            Command="{Binding Data.RedoCommand, Source={StaticResource ControlProxy}}" 
                            ToolTip="é‡åš" Style="{StaticResource ToolbarButtonStyle}"/>
                </StackPanel>
                
                <!-- TitleActionBar (æ“ä½œæŒ‰é’®) -->
                <controls:TitleActionBar Grid.Column="2" x:Name="TitleActionBar" Mode="Path"/>
                
                <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® (ä¸‹æ‹‰èœå•) -->
                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <Button Name="PropertiesBtn" Content="&#xE946;" 
                            FontFamily="Segoe MDL2 Assets" FontSize="14"
                            Click="PropertiesBtn_Click" Style="{StaticResource ModernToolbarButtonStyle}" ToolTip="å±žæ€§"
                            Margin="0,0,4,0"/>
                    <Button Name="ViewModeBtn" Content="{DynamicResource Icon_ViewList}" 
                            FontFamily="{DynamicResource IconFontFamily}" FontSize="14"
                            Click="ViewModeBtn_DropDown" Style="{StaticResource ModernToolbarButtonStyle}" ToolTip="è§†å›¾æ¨¡å¼">
                        <Button.ContextMenu>
                            <ContextMenu Name="ViewModeMenu">
                                <MenuItem Header="ðŸ“‹ åˆ—è¡¨" Tag="List" Click="ViewModeMenuItem_Click"/>
                                <MenuItem Header="ðŸ“ ç´§å‡‘åˆ—è¡¨" Tag="Compact" Click="ViewModeMenuItem_Click"/>
                                <Separator/>
                                <MenuItem Header="ðŸ–¼ï¸ ç¼©ç•¥å›¾" Tag="Thumbnail" Click="ViewModeMenuItem_Click"/>
                                <MenuItem Header="ðŸ”² å¹³é“º" Tag="Tiles" Click="ViewModeMenuItem_Click"/>
                                <MenuItem Header="ðŸ“Ž å°å›¾æ ‡" Tag="SmallIcons" Click="ViewModeMenuItem_Click"/>
                                <Separator/>
                                <MenuItem Header="ðŸ“„ å†…å®¹" Tag="Content" Click="ViewModeMenuItem_Click"/>
                            </ContextMenu>
                        </Button.ContextMenu>
                    </Button>
                </StackPanel>
                
                <!-- æœç´¢/ç­›é€‰æŒ‰é’® -->
                <StackPanel Grid.Column="6" Orientation="Horizontal">
                    <Button Name="FilterBtn" Content="&#xE71C;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                            Click="FilterBtn_Click"
                            Style="{StaticResource ModernToolbarButtonStyle}" ToolTip="ç­›é€‰"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Row 2: æœç´¢çŠ¶æ€æç¤ºæ¡ -->
        <Border x:Name="SearchStatusBar" Grid.Row="2" Background="{DynamicResource AccentSubtleBrush}" 
                Visibility="{Binding IsSearching, Converter={StaticResource BooleanToVisibilityConverter}}" Padding="8,4" Margin="0,0,0,4">
            <StackPanel Orientation="Horizontal">
                <TextBlock x:Name="SearchStatusIcon" Text="ðŸ”" Margin="0,0,6,0" VerticalAlignment="Center"/>
                <TextBlock x:Name="SearchStatusText" Text="{Binding SearchStatusText}" 
                          Foreground="{DynamicResource ForegroundBrush}" FontSize="12" VerticalAlignment="Center"/>
            </StackPanel>
        </Border>
        
        <!-- Row 3: æ–‡ä»¶åˆ—è¡¨ -->
        <controls:FileListControl Grid.Row="3" x:Name="FileList" FocusVisualStyle="{x:Null}"/>
        
        <!-- Row 4: æ°´å¹³åˆ†å‰²å™¨ï¼ˆæ–‡ä»¶åˆ—è¡¨ä¸Žä¿¡æ¯é¢æ¿ä¹‹é—´ï¼‰ -->
        <controls:CollapsibleGridSplitter Grid.Row="4" 
                      Style="{StaticResource HorizontalCollapsibleGridSplitterStyle}"
                      CollapseMode="Both"
                      HorizontalAlignment="Stretch"
                      Panel.ZIndex="999"
                      AutoFillNeighbor="True"
                      ShowsPreview="True"/>
        
        <!-- Row 5: å³ä¾§ä¿¡æ¯é¢æ¿ï¼ˆçŽ°åœ¨ç§»åŠ¨åˆ°åº•éƒ¨ä½œä¸ºä¿¡æ¯æ ï¼‰ -->
        <Border Grid.Row="5" Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderDefaultBrush}" BorderThickness="0,1,0,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Margin="8,4">
                <!-- æ–‡ä»¶ä¿¡æ¯é¢æ¿ -->
                <StackPanel x:Name="FileInfoPanel" Margin="4"/>
            </ScrollViewer>
        </Border>

        <!-- ç„¦ç‚¹è¾¹æ¡†è¦†ç›–å±‚ (Grid.RowSpan="5") -->
        <Border x:Name="FocusBorder"
                Grid.Row="0" Grid.RowSpan="5"
                BorderThickness="2"
                Margin="-2"
                BorderBrush="Transparent"
                IsHitTestVisible="False"
                Panel.ZIndex="1000"/>

        <!-- ç­›é€‰å¼¹å‡ºé¢æ¿ -->
        <Popup x:Name="FilterPopup" PlacementTarget="{Binding ElementName=FilterBtn}" 
               StaysOpen="False" AllowsTransparency="True" PopupAnimation="Fade"
               Placement="Bottom" VerticalOffset="4">
            <Border Background="{DynamicResource AppBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="8" Effect="{DynamicResource DropShadowEffect}">
                <controls:FilterPanel x:Name="FilterPanelControl"/>
            </Border>
        </Popup>
    </Grid>
</UserControl>
